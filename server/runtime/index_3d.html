<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <link rel="icon" href="icon/icon.png" type="image/png">
        <link rel="apple-touch-icon" href="icon/icon.png">
        <link rel="stylesheet" type="text/css" href="fonts/gamefont.css">
        <title>Game</title>
    </head>
    <body style="background-color: black; touch-action: none">
        <script type="text/javascript" src="js/libs/three.global.min.js"></script>
        <script type="text/javascript" src="js/libs/fpsmeter.js"></script>
        <script type="text/javascript" src="js/libs/lz-string.js"></script>
        <script type="text/javascript" src="js/libs/iphone-inline-video.browser.js"></script>
        <script type="text/javascript" src="js/3d/renderer/RendererFactory.js"></script>
        <script type="text/javascript" src="js/3d/renderer/RendererStrategy.js"></script>
        <script type="text/javascript" src="js/3d/renderer/three/ThreeRendererFactory.js"></script>
        <script type="text/javascript" src="js/3d/renderer/three/ThreeRendererStrategy.js"></script>
        <script type="text/javascript" src="js/3d/renderer/three/ThreeContainer.js"></script>
        <script type="text/javascript" src="js/3d/renderer/three/ThreeSprite.js"></script>
        <script type="text/javascript" src="js/3d/renderer/three/ThreeGraphicsNode.js"></script>
        <script type="text/javascript" src="js/3d/renderer/three/ThreeTilemap.js"></script>
        <script type="text/javascript" src="js/3d/renderer/three/ThreeWaterShader.js"></script>
        <script type="text/javascript" src="js/3d/renderer/three/ThreeFilters.js"></script>
        <script type="text/javascript" src="js/3d/rpg_core.js"></script>
        <script type="text/javascript" src="js/3d/rpg_managers.js"></script>
        <script type="text/javascript" src="js/3d/DevPanelUtils.js"></script>
        <script type="text/javascript" src="js/3d/ThreeDevOverlay.js"></script>
        <script type="text/javascript" src="js/3d/RenderModeDevPanel.js"></script>
        <script type="text/javascript" src="js/3d/TileIdDevOverlay.js"></script>
        <script type="text/javascript" src="js/3d/MemoryDevPanel.js"></script>
        <script type="text/javascript" src="js/3d/DepthDebugPanel.js"></script>
        <script type="text/javascript" src="js/3d/FogOfWarDevPanel.js"></script>
        <script type="text/javascript" src="js/3d/CameraZoneDevOverlay.js"></script>
        <script type="text/javascript" src="js/3d/rpg_objects.js"></script>
        <script type="text/javascript" src="js/3d/rpg_scenes.js"></script>
        <script type="text/javascript" src="js/3d/rpg_sprites.js"></script>
        <script type="text/javascript" src="js/3d/rpg_windows.js"></script>
        <script type="text/javascript" src="js/3d/PluginTween.js"></script>
        <script type="text/javascript" src="js/3d/Mode3D.js"></script>
        <script type="text/javascript" src="js/3d/ShadowAndLight.js"></script>
        <script type="text/javascript" src="js/3d/PostProcessEffects.js"></script>
        <script type="text/javascript" src="js/3d/PostProcess.js"></script>
        <script type="text/javascript" src="js/3d/PictureShader.js"></script>
        <script type="text/javascript" src="js/3d/FogOfWar.js"></script>
        <script type="text/javascript" src="js/3d/FogOfWar3DVolume.js"></script>
        <script type="text/javascript" src="js/3d/ExtendedText.js"></script>
        <script type="text/javascript" src="js/plugins.js"></script>
        <script type="text/javascript">
        // ── ServiceWorker 번들 초기화 ─────────────────────────────────────────
        // SW가 img/audio/data ZIP을 Cache API에 저장한 뒤 main.js를 로드.
        // SW 미지원 환경이거나 번들 API 없으면 바로 main.js 로드.
        (function() {
            var overlay = null;
            var mainLoaded = false;  // loadMain() 이중 호출 방지

            function createOverlay() {
                overlay = document.createElement('div');
                overlay.id = 'bundle-overlay';
                overlay.style.cssText = [
                    'position:fixed;inset:0;background:#000;z-index:9999',
                    'display:flex;flex-direction:column;align-items:center;justify-content:center',
                    'font-family:"Segoe UI",Arial,sans-serif;color:#ccc',
                ].join(';');
                overlay.innerHTML = [
                    '<div id="bo-title" style="font-size:15px;margin-bottom:20px;">리소스 다운로드 중...</div>',
                    '<div id="bo-bar-wrap" style="width:360px;background:#222;border-radius:4px;overflow:hidden;height:8px">',
                    '  <div id="bo-bar" style="height:8px;width:0%;background:linear-gradient(90deg,#2c6fc7,#55aaff);transition:width 0.15s"></div>',
                    '</div>',
                    '<div id="bo-files" style="margin-top:12px;width:360px;font-size:12px;color:#888;display:flex;flex-direction:column;gap:4px"></div>',
                ].join('');
                document.body.appendChild(overlay);
            }

            function setBar(pct) {
                if (!overlay) return;
                document.getElementById('bo-bar').style.width = Math.min(100, Math.max(0, pct)) + '%';
            }
            function setTitle(t) {
                if (!overlay) return;
                document.getElementById('bo-title').textContent = t;
            }
            function mb(b) { return (b / 1048576).toFixed(1) + ' MB'; }

            function removeOverlay() {
                if (overlay) { overlay.remove(); overlay = null; }
            }

            function loadMain() {
                if (mainLoaded) return;
                mainLoaded = true;
                removeOverlay();
                var s = document.createElement('script');
                s.type = 'text/javascript';
                s.src = 'js/3d/main.js';
                document.body.appendChild(s);
            }

            if (!('serviceWorker' in navigator)) {
                console.warn('[SW] navigator.serviceWorker 없음 (iframe sandbox 제한 또는 미지원 환경) → 번들 없이 로드');
                loadMain();
                return;
            }

            // SW 메시지 수신
            // bundle-ready / bundle-skip / bundle-error → 캐시 준비 완료(또는 스킵) → 게임 시작
            // bundle-error의 경우도 게임 시작 (캐시 없이 네트워크에서 로드)
            navigator.serviceWorker.addEventListener('message', function(e) {
                var msg = e.data;
                if (!msg) return;
                if (msg.type === 'bundle-downloading') {
                    var filesDiv = document.getElementById('bo-files');
                    if (filesDiv) {
                        var safeId = 'bo-f-' + msg.file.replace(/[^a-z0-9]/gi, '_');
                        if (!document.getElementById(safeId)) {
                            var row = document.createElement('div');
                            row.id = safeId;
                            row.style.cssText = 'display:flex;justify-content:space-between';
                            row.innerHTML = '<span>' + msg.file + '</span><span id="' + safeId + '-sz">...</span>';
                            filesDiv.appendChild(row);
                        }
                    }
                } else if (msg.type === 'bundle-download-progress') {
                    var dlPct = msg.totalSize > 0 ? msg.totalReceived / msg.totalSize * 50 : 0;
                    setBar(dlPct);
                    if (msg.files) {
                        msg.files.forEach(function(f) {
                            var szEl = document.getElementById('bo-f-' + f.file.replace(/[^a-z0-9]/gi, '_') + '-sz');
                            if (szEl) szEl.textContent = f.total > 0 ? mb(f.received) + ' / ' + mb(f.total) : mb(f.received);
                        });
                    }
                } else if (msg.type === 'bundle-progress') {
                    setTitle('압축 해제 중...');
                    var extPct = 50 + (msg.totalFiles > 0 ? msg.loadedFiles / msg.totalFiles * 50 : 0);
                    setBar(extPct);
                    var filesDiv2 = document.getElementById('bo-files');
                    if (filesDiv2) filesDiv2.textContent = msg.loadedFiles + ' / ' + msg.totalFiles + ' 파일';
                } else if (msg.type === 'bundle-ready' || msg.type === 'bundle-skip' || msg.type === 'bundle-error') {
                    if (msg.type === 'bundle-skip')  console.warn('[SW] bundle-skip (번들 없음 → 직접 네트워크 로드):', msg.reason);
                    if (msg.type === 'bundle-error') console.warn('[SW] bundle error:', msg.file, msg.error);
                    loadMain();
                }
            });

            // 안전망 타임아웃: SW가 응답하지 않아도 120초 후 게임 강제 시작
            var fallbackTimer = setTimeout(loadMain, 120000);

            createOverlay();

            navigator.serviceWorker.register('sw.js', { scope: './' })
                .then(function(reg) {
                    if (reg.active && !reg.installing && !reg.waiting) {
                        // 이미 활성화된 SW, 새 설치 없음 → 번들 캐시 이미 준비됨 → 바로 시작
                        clearTimeout(fallbackTimer);
                        loadMain();
                    }
                    // installing / waiting → SW install 이벤트에서 bundle-ready 메시지가 오면 loadMain()
                })
                .catch(function(err) {
                    console.warn('[SW] 등록 실패:', err);
                    clearTimeout(fallbackTimer);
                    loadMain();
                });
        })();
        </script>
    </body>
</html>
