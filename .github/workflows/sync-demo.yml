name: Sync to Demo Repo

on:
  push:
    branches: [main]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout editor repo
        uses: actions/checkout@v4
        with:
          path: editor

      - name: Checkout demo repo
        uses: actions/checkout@v4
        with:
          repository: gosuni2025/rpgmaker-mv-editor-demo
          token: ${{ secrets.DEMO_REPO_TOKEN }}
          path: demo

      - name: Sync editor code to demo repo
        run: |
          rsync -a --delete \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='dist-electron' \
            --exclude='electron' \
            --exclude='electron-builder.yml' \
            --exclude='*.local.md' \
            --exclude='CLAUDE.md' \
            --exclude='release' \
            --exclude='extracted_maps' \
            --exclude='plan.md' \
            editor/client/ demo/client/
          rsync -a --delete \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='dist' \
            editor/server/ demo/server/
          cp editor/README.md demo/README.md

      - name: Commit and push if changed
        working-directory: demo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to sync"
          else
            git commit -m "sync: editor update from $(cd ../editor && git rev-parse --short HEAD)"
            git push
          fi
