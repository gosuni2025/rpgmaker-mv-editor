From 9e26111e8deab5124174a8841e7488986ffece5d Mon Sep 17 00:00:00 2001
From: gosuni2025 <gosuni2025@gmail.com>
Date: Wed, 18 Feb 2026 16:25:26 +0900
Subject: [PATCH] =?UTF-8?q?fix:=203D=20=EB=B9=8C=EB=B3=B4=EB=93=9C=20?=
 =?UTF-8?q?=EC=BA=90=EB=A6=AD=ED=84=B0=EA=B0=80=20=ED=83=80=EC=9D=BC=20?=
 =?UTF-8?q?=EA=B2=BD=EA=B3=84=EB=A9=B4=EC=97=90=20=EB=A0=8C=EB=8D=94?=
 =?UTF-8?q?=EB=A7=81=EB=90=98=EB=8D=98=20=EB=AC=B8=EC=A0=9C=20=EC=88=98?=
 =?UTF-8?q?=EC=A0=95?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

screenY가 타일 하단(bottom) 기준이라 빌보드가 타일 경계에 나타나던 문제를
th/2만큼 보정하여 타일 중심에 위치하도록 수정.
billboard === false인 이벤트는 기존 위치 유지.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
---
 server/runtime/js/Mode3D.js | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/server/runtime/js/Mode3D.js b/server/runtime/js/Mode3D.js
index d994485..5f9dd40 100644
--- a/server/runtime/js/Mode3D.js
+++ b/server/runtime/js/Mode3D.js
@@ -875,7 +875,22 @@
                 this._heightOffset = bz * th;
             } catch (e) { /* ignore */ }
         }
-        // 3D 모드: depth test가 upper layer 가림을 처리하므로 z=5 해킹 불필요
+        // 3D 모드 빌보드: screenY가 타일 하단(bottom)이므로 타일 중심으로 보정
+        if (ConfigManager.mode3d && this._character) {
+            var isBillboard = true;
+            if (typeof this._character.page === 'function') {
+                try {
+                    var page = this._character.page();
+                    if (page && page.billboard === false) {
+                        isBillboard = false;
+                    }
+                } catch (e) { /* ignore */ }
+            }
+            if (isBillboard) {
+                var th = ($gameMap && $gameMap.tileHeight) ? $gameMap.tileHeight() : 48;
+                this.y -= th / 2;
+            }
+        }
     };
 
     var _Spriteset_Map_createCharacters = Spriteset_Map.prototype.createCharacters;
-- 
2.50.1 (Apple Git-155)

